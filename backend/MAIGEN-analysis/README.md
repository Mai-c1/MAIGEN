## 模块概述
MAIGEN-analysis 是 MAIGEN 平台的 AI 协同分析模块，负责处理任务的核心分析流程，包括题目分析、策略制定、代码生成和代码评审等关键环节。该模块采用多智能体协同工作模式，确保生成的测试数据高质量、覆盖全面。


## 多AI工作流程

### AI流水线式工作流程
1. **题目分析AI**：分析题目描述，提取关键信息和约束条件
2. **策略构造AI**：根据题目分析结果，思考数据构造策略
3. **代码生成AI**：根据构造策略，编写数据生成代码
4. **代码评审AI**：评审生成的代码是否合理

### 工作机制
- **状态机模式**：类似于订单业务的状态机，每个AI负责一个阶段
- **打回机制**：代码评审不通过时打回重做，最多打回3次
- **死信队列**：打回3次后仍不通过，或AI调用失败多次后，放入死信队列
- **异常处理**：死信队列的任务记录到数据库和异常日志，告知用户任务失败
- **并行处理**：多个任务可以在不同阶段并行工作

### AI模型选择
- 暂定使用 Qwen3 模型
- API调用方式：查阅千文官方文档SDK，可能与Spring-AI集成
- 防止AI输入过多导致内容偏差：采用多AI分工协作

## 编排器模式

### 核心概念
- **状态机**：定义任务的各个状态（待分析、分析中、生成中、验证中、完成、失败等）
- **事件触发**：状态之间的转换由事件触发
- **流程定义**：预先定义任务执行的完整流程
- **协调中心**：编排器作为中央协调器，监控和管理整个流程

### 技术实现
- 使用 RabbitMQ 实现事件传递
- 使用状态机管理状态转换
- 使用分布式锁确保任务执行的唯一性
- 使用监控系统追踪任务执行进度
# 业务场景



## 核心业务场景

### 1. 任务分析场景

#### 场景描述：从消息队列获取任务并进行初步分析

**步骤1：接收任务**
- 从【等待分析】消息队列取出任务ID
- 根据任务ID从缓存中获取完整的任务信息
- 验证任务信息的完整性和有效性

**步骤2：题目分析**
- 题目分析AI读取题目描述、输入输出格式、数据范围等信息
- 识别题目中的关键约束条件和边界情况
- 提取题目中的特殊要求和限制

**步骤3：分析结果处理**
- 将分析结果存储到缓存中
- 准备后续策略制定所需的分析数据

### 2. 策略制定场景

#### 场景描述：基于题目分析结果制定数据生成策略

**步骤1：获取分析数据**
- 从缓存中获取题目分析结果
- 读取用户设置的期望数据构造策略

**步骤2：策略构造**
- 策略构造AI根据题目分析结果制定详细的数据生成策略
- 确定每种数据类型的分布比例和具体参数
- 生成符合题目要求的测试点分布计划

**步骤3：策略验证**
- 验证策略是否满足用户设置的约束条件
- 确保策略能够覆盖所有关键边界情况
- 将最终策略存储到缓存中

### 3. 代码生成场景

#### 场景描述：根据制定的策略生成数据生成代码

**步骤1：获取策略数据**
- 从缓存中获取制定好的生成策略
- 读取题目分析结果和用户要求

**步骤2：代码生成**
- 代码生成AI根据策略编写数据生成代码
- 确保代码能够正确实现所有策略要求
- 生成符合安全标准的代码

**步骤3：代码优化**
- 优化生成代码的执行效率
- 确保代码的可读性和可维护性
- 将生成的代码存储到缓存中

### 4. 代码评审场景

#### 场景描述：评审生成的代码确保质量和安全性

**步骤1：获取生成代码**
- 从缓存中获取生成的数据生成代码
- 读取相关的策略和题目信息

**步骤2：代码评审**
- 代码评审AI对生成的代码进行全面评审
- 检查代码的正确性和安全性
- 验证代码是否符合策略要求

**步骤3：评审结果处理**
- 记录评审结果和建议
- 对评审通过的代码进行标记
- 对评审未通过的代码提出修改建议

### 5. 结果处理场景

#### 场景描述：处理分析结果并发送到下一阶段

**步骤1：收集分析结果**
- 汇总所有分析、策略、代码生成和评审结果
- 确保所有必要的数据都已准备就绪

**步骤2：缓存更新**
- 将完整的分析结果和生成的代码更新到缓存
- 确保缓存中的数据完整且最新

**步骤3：消息队列处理**
- 将任务ID放入【等待执行】消息队列（由MAIGEN-sandbox端消费）
- 将任务ID放入【分析完成】消息队列（由MAIGEN-api端消费）
- 通知相关模块分析流程已完成

## 开发计划场景
- **第一阶段**：消息队列集成（接收任务、发送结果）
- **第二阶段**：题目分析功能（约束条件识别、边界情况提取）
- **第三阶段**：策略制定功能（数据类型分布、测试点规划）
- **第四阶段**：代码生成功能（策略转代码、代码优化）
- **第五阶段**：代码评审功能（质量检查、安全验证）