# 数据库设计方案 - MAIGEN

## 1. 数据库表结构

### 1.1 用户管理模块

#### 1.1.1 `user` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 用户ID |
| `username` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 用户名 |
| `password` | `VARCHAR(100)` | `NOT NULL` | 密码（加密存储） |
| `email` | `VARCHAR(100)` | `UNIQUE NOT NULL` | 邮箱 |
| `nickname` | `VARCHAR(50)` | `NOT NULL` | 昵称 |
| `avatar` | `VARCHAR(255)` | `DEFAULT NULL` | 头像链接 |
| `invitation_code` | `VARCHAR(32)` | `UNIQUE NOT NULL` | 邀请码 |
| `points` | `INT` | `DEFAULT 0` | 积分 |
| `status` | `TINYINT` | `DEFAULT 1` | 状态（1：正常，0：禁用） |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

#### 1.1.2 `role` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 角色ID |
| `name` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 角色名称 |
| `description` | `VARCHAR(255)` | `DEFAULT NULL` | 角色描述 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

#### 1.1.3 `permission` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 权限ID |
| `code` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 权限编码 |
| `name` | `VARCHAR(50)` | `NOT NULL` | 权限名称 |
| `description` | `VARCHAR(255)` | `DEFAULT NULL` | 权限描述 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

#### 1.1.4 `user_role` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `user_id` | `BIGINT` | `NOT NULL` | 用户ID，关联user.id |
| `role_id` | `BIGINT` | `NOT NULL` | 角色ID，关联role.id |
| `PRIMARY KEY` | | `(user_id, role_id)` | 联合主键 |

#### 1.1.5 `role_permission` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `role_id` | `BIGINT` | `NOT NULL` | 角色ID，关联role.id |
| `permission_id` | `BIGINT` | `NOT NULL` | 权限ID，关联permission.id |
| `PRIMARY KEY` | | `(role_id, permission_id)` | 联合主键 |

#### 1.1.6 `invitation` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 邀请记录ID |
| `inviter_id` | `BIGINT` | `NOT NULL` | 邀请人ID，关联user.id |
| `invitee_id` | `BIGINT` | `NOT NULL` | 被邀请人ID，关联user.id |
| `invitation_code` | `VARCHAR(32)` | `NOT NULL` | 邀请码 |
| `status` | `TINYINT` | `DEFAULT 1` | 状态（1：成功，0：失败） |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

### 1.2 积分管理模块

#### 1.2.1 `points_record` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 积分记录ID |
| `user_id` | `BIGINT` | `NOT NULL` | 用户ID，关联user.id |
| `amount` | `INT` | `NOT NULL` | 积分数量，可正可负 |
| `source` | `VARCHAR(50)` | `NOT NULL` | 来源/用途（注册、邀请、创建任务、下载社区数据、充值等） |
| `related_id` | `VARCHAR(50)` | `DEFAULT NULL` | 关联ID（任务ID、社区内容ID等） |
| `description` | `VARCHAR(255)` | `DEFAULT NULL` | 描述 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

#### 1.2.2 `points_rule` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 规则ID |
| `code` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 规则编码 |
| `name` | `VARCHAR(50)` | `NOT NULL` | 规则名称 |
| `value` | `INT` | `NOT NULL` | 规则值（积分数量） |
| `description` | `VARCHAR(255)` | `DEFAULT NULL` | 规则描述 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

### 1.3 任务管理模块

#### 1.3.1 `task` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY` | 任务ID（MyBatis-Plus雪花ID） |
| `user_id` | `BIGINT` | `NOT NULL` | 用户ID，关联user.id |
| `title` | `VARCHAR(100)` | `NOT NULL` | 任务标题 |
| `problem_description` | `TEXT` | `NOT NULL` | 题目描述（Markdown格式） |
| `standard_code` | `TEXT` | `NOT NULL` | 标准程序代码 |
| `testcase_count` | `INT` | `NOT NULL` | 测试点数量 |
| `status` | `TINYINT` | `DEFAULT 0` | 状态（0：待处理，1：分析中，2：生成中，3：验证中，4：完成，5：失败，6：超时） |
| `progress` | `INT` | `DEFAULT 0` | 进度（0-100） |
| `total_points` | `INT` | `DEFAULT 0` | 消耗积分 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |
| `expired_at` | `DATETIME` | `DEFAULT NULL` | 过期时间 |

#### 1.3.2 `task_testcase` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 测试点ID |
| `task_id` | `BIGINT` | `NOT NULL` | 任务ID，关联task.id |
| `testcase_index` | `INT` | `NOT NULL` | 测试点序号 |
| `strategy_id` | `BIGINT` | `DEFAULT NULL` | 策略ID，关联task_strategy.id |
| `parameters` | `JSON` | `DEFAULT NULL` | 测试点参数（JSON格式） |
| `status` | `TINYINT` | `DEFAULT 0` | 状态（0：待处理，1：处理中，2：完成，3：失败） |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

#### 1.3.3 `task_strategy` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 策略ID |
| `name` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 策略名称 |
| `description` | `VARCHAR(255)` | `DEFAULT NULL` | 策略描述 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

#### 1.3.4 `task_execution_log` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 日志ID |
| `task_id` | `BIGINT` | `NOT NULL` | 任务ID，关联task.id |
| `ai_role` | `VARCHAR(50)` | `NOT NULL` | AI角色（题目分析AI、策略构造AI、代码生成AI、代码评审AI） |
| `ai_response` | `TEXT` | `DEFAULT NULL` | AI接口返回内容 |
| `status` | `TINYINT` | `NOT NULL` | 状态（1：成功，0：失败） |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

### 1.4 数据管理模块

#### 1.4.1 `generated_data` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 数据ID |
| `task_id` | `BIGINT` | `NOT NULL` | 任务ID，关联task.id |
| `file_name` | `VARCHAR(100)` | `NOT NULL` | 文件名 |
| `file_path` | `VARCHAR(255)` | `NOT NULL` | 文件路径（阿里云OSS或MinIO） |
| `download_url` | `VARCHAR(255)` | `NOT NULL` | 下载链接 |
| `size` | `BIGINT` | `DEFAULT 0` | 文件大小（字节） |
| `status` | `TINYINT` | `DEFAULT 1` | 状态（1：可用，0：过期） |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `expired_at` | `DATETIME` | `DEFAULT NULL` | 过期时间 |

### 1.5 社区管理模块

#### 1.5.1 `community_content` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 社区内容ID |
| `user_id` | `BIGINT` | `NOT NULL` | 用户ID，关联user.id |
| `title` | `VARCHAR(100)` | `NOT NULL` | 标题 |
| `description` | `TEXT` | `NOT NULL` | 描述（Markdown格式） |
| `data_file_path` | `VARCHAR(255)` | `NOT NULL` | 数据文件路径 |
| `status` | `TINYINT` | `DEFAULT 0` | 状态（0：审核中，1：通过，2：不通过） |
| `view_count` | `INT` | `DEFAULT 0` | 浏览次数 |
| `download_count` | `INT` | `DEFAULT 0` | 下载次数 |
| `points` | `INT` | `DEFAULT 0` | 所需积分 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

#### 1.5.2 `community_unlock` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 解锁记录ID |
| `user_id` | `BIGINT` | `NOT NULL` | 用户ID，关联user.id |
| `community_id` | `BIGINT` | `NOT NULL` | 社区内容ID，关联community_content.id |
| `unlock_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 解锁时间 |
| `PRIMARY KEY` | | `(user_id, community_id)` | 联合主键 |

### 1.6 系统管理模块

#### 1.6.1 `system_config` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 配置ID |
| `code` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 配置编码 |
| `name` | `VARCHAR(50)` | `NOT NULL` | 配置名称 |
| `value` | `VARCHAR(255)` | `NOT NULL` | 配置值 |
| `description` | `VARCHAR(255)` | `DEFAULT NULL` | 配置描述 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

#### 1.6.2 `statistics` 表
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 统计ID |
| `code` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 统计编码 |
| `name` | `VARCHAR(50)` | `NOT NULL` | 统计名称 |
| `value` | `VARCHAR(50)` | `NOT NULL` | 统计值 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

## 2. 数据库设计建议

### 2.1 存储建议

1. **文件存储**：
   - 建议使用阿里云OSS或MinIO存储生成的测试数据文件
   - 优势：
     - 高可靠性：多副本存储，数据安全
     - 弹性扩展：存储容量可根据需求自动扩展
     - 低成本：按实际使用量付费
     - 便捷管理：提供丰富的API和管理界面

2. **过期策略**：
   - 生成的数据文件：设置7天过期时间
   - 社区分享的数据：审核通过后永久保存
   - 实现方式：
     - 在数据库中记录文件的过期时间
     - 使用定时任务定期清理过期文件
     - 清理时更新数据库中文件的状态为过期

### 2.2 性能优化

1. **索引优化**：
   - 为频繁查询的字段添加索引，如user_id、task_id、status等
   - 为联合查询的字段创建复合索引

2. **缓存优化**：
   - 使用Redis缓存热点数据，如用户信息、任务状态、系统配置等
   - 缓存更新策略：先更新数据库，再同步到缓存
   - 使用消息队列驱动统计数据更新到缓存

3. **查询优化**：
   - 使用分页查询减少数据传输量
   - 避免使用SELECT *，只查询需要的字段
   - 合理使用JOIN，避免复杂的多表关联

4. **并发控制**：
   - 使用分布式锁确保任务执行的唯一性
   - 合理设置事务隔离级别，避免脏读、幻读等问题

### 2.3 安全性

1. **密码安全**：
   - 使用Sa-Token自带的MD5加密存储密码
   - 定期提醒用户修改密码

2. **SQL注入防护**：
   - 使用MyBatis-Plus的参数化查询，防止SQL注入
   - 对用户输入进行严格验证

3. **权限控制**：
   - 基于RBAC模式实现权限管理
   - 对敏感操作进行权限验证

4. **数据备份**：
   - 定期备份数据库，确保数据安全
   - 制定灾难恢复计划

## 3. 状态枚举设计

### 3.1 任务状态枚举类

```java
public enum TaskStatus {
    PENDING(0, "待处理"),
    ANALYZING(1, "分析中"),
    GENERATING(2, "生成中"),
    VERIFYING(3, "验证中"),
    COMPLETED(4, "完成"),
    FAILED(5, "失败"),
    TIMEOUT(6, "超时");

    private final int code;
    private final String message;

    TaskStatus(int code, String message) {
        this.code = code;
        this.message = message;
    }

    public int getCode() {
        return code;
    }

    public String getMessage() {
        return message;
    }

    public static TaskStatus getByCode(int code) {
        for (TaskStatus status : values()) {
            if (status.code == code) {
                return status;
            }
        }
        return null;
    }
}
```

### 3.2 测试点状态枚举类

**说明**：TestcaseStatus用于表示task_testcase表中每个测试点的处理状态。在任务执行过程中，每个测试点都会经历不同的处理阶段，这个枚举类将这些状态映射为数字，避免在代码中使用魔法数字。

```java
public enum TestcaseStatus {
    PENDING(0, "待处理"),
    PROCESSING(1, "处理中"),
    COMPLETED(2, "完成"),
    FAILED(3, "失败");

    private final int code;
    private final String message;

    TestcaseStatus(int code, String message) {
        this.code = code;
        this.message = message;
    }

    public int getCode() {
        return code;
    }

    public String getMessage() {
        return message;
    }

    public static TestcaseStatus getByCode(int code) {
        for (TestcaseStatus status : values()) {
            if (status.code == code) {
                return status;
            }
        }
        return null;
    }
}
```

### 3.3 社区内容审核状态枚举类

```java
public enum CommunityAuditStatus {
    PENDING(0, "审核中"),
    APPROVED(1, "通过"),
    REJECTED(2, "不通过");

    private final int code;
    private final String message;

    CommunityAuditStatus(int code, String message) {
        this.code = code;
        this.message = message;
    }

    public int getCode() {
        return code;
    }

    public String getMessage() {
        return message;
    }

    public static CommunityAuditStatus getByCode(int code) {
        for (CommunityAuditStatus status : values()) {
            if (status.code == code) {
                return status;
            }
        }
        return null;
    }
}
```

## 4. 关键设计说明

### 4.1 用户邀请关系
- 用户表中不存储被邀请人ID，通过invitation表查询邀请关系
- invitation表记录完整的邀请信息，包括邀请人、被邀请人、邀请码等

### 4.2 任务ID设计
- 任务ID使用MyBatis-Plus的雪花ID生成器
- 雪花ID的优势：
  - 全局唯一，不会重复
  - 时间有序，便于排序和查询
  - 分布式环境下也能保证唯一性
  - 不需要数据库自增，性能更好

### 4.3 数据下载机制
- 生成的数据打包成ZIP文件，存储在阿里云OSS或MinIO
- generated_data表提供下载链接字段
- 用户下载自己生成的数据不需要记录
- 用户下载社区数据时，需要先解锁：
  1. 用户点击解锁按钮
  2. 系统扣除用户积分并记录在points_record表
  3. 系统在community_unlock表中记录解锁关系
  4. 解锁后，用户可以查看并使用下载链接
  5. 后续用户再次访问时，系统检查community_unlock表，已解锁的内容直接显示下载链接

### 4.4 积分记录
- points_record表记录所有积分变动
- 包括：注册奖励、邀请奖励、任务消耗、社区下载消耗、充值等
- amount字段可正可负，正数表示增加，负数表示减少

### 4.5 社区内容管理
- community_content表存储社区分享的内容
- 审核状态：审核中、通过、不通过
- 排序规则：时间、热度（浏览次数+下载次数）
- 下载权限通过积分兑换获得，兑换后永久有效

## 5. 社区内容解锁流程

### 5.1 解锁流程
1. **用户访问社区内容**：用户B浏览社区内容，看到用户A分享的题目
2. **查看下载权限**：系统检查community_unlock表，判断用户B是否已解锁该内容
   - 若已解锁：直接显示下载链接
   - 若未解锁：显示"解锁"按钮，提示需要消耗的积分
3. **用户点击解锁**：用户B确认解锁，系统执行以下操作：
   - 检查用户积分是否足够
   - 扣除用户积分，在points_record表中记录
   - 在community_unlock表中添加解锁记录
   - 增加community_content表中的download_count
   - 为用户A增加积分奖励（如果设置了分享奖励）
4. **显示下载链接**：解锁成功后，显示下载链接给用户B
5. **后续访问**：用户B后续访问该内容时，系统检查到已解锁，直接显示下载链接

### 5.2 下载链接生成
- 下载链接可以是：
  1. 基于文件存储服务（如阿里云OSS）生成的临时签名URL
  2. 系统内部的下载接口，需要验证用户身份和解锁状态
- 推荐使用临时签名URL，优势：
  - 安全性高，有过期时间
  - 减轻系统负担，文件直接从存储服务下载
  - 支持大文件下载

## 6. 总结

本数据库设计方案基于MAIGEN系统的需求文档和用户反馈，设计了完整的数据库表结构，包括用户管理、积分管理、任务管理、数据管理、社区管理和系统管理等模块。

方案考虑了系统的性能、安全性和可扩展性，提供了存储建议、性能优化和安全性措施。同时，设计了详细的状态枚举类，避免了魔法数字的使用。

针对社区内容的解锁机制，特别设计了community_unlock表来记录用户的解锁状态，实现了"积分兑换下载权限"的功能，满足了用户的需求场景。

该设计方案可以作为MAIGEN系统开发的数据库设计参考，根据实际开发过程中的需求变化，可能需要进行适当的调整和优化。