# 产品需求文档 (PRD) - MAIGEN

## 产品概述

我们为 OI/ICPC 参赛者和出题人建立一个自动化数据生成平台，用于快速生成高强度、边界覆盖全的测试数据。

## 技术栈选择

| 分类 | 技术 | 版本 | 说明 |
| --- | --- | --- | --- |
| 后端 | Spring Boot | 3.x | 核心框架 |
| 前端 | React | 最新版 | 用户界面，后续可能迁移到 Vue 3 |
| 数据库 | MySQL | 8.0+ | 数据存储 |
| 消息队列 | RabbitMQ | 3.10+ | 任务编排和异步处理 |
| 缓存 | Redis | 7.0+ | 缓存和会话管理 |
| 认证 | Sa-Token | 最新版 | 用户认证和权限管理 |
| 邮箱 | Spring Email | - | 邮箱验证码发送 |
| 前端编辑器 | Ace | 最新版 | 代码编辑器 |
| 部署 | Docker Compose | 最新版 | 容器化部署

## 核心功能模块

### 1. 用户管理
- **注册功能**：支持邮箱注册，验证码验证
  - 邮箱验证：使用 Spring Email 发送验证码
  - 验证码规则：5分钟内有效，1分钟内只能发送1次
  - 注册奖励：50积分
  - 邀请机制：邀请人获得20积分，被邀请人获得5积分
- **登录功能**：账号密码登录，记住密码，忘记密码重置
  - 记住密码：将token存储在浏览器中，每次请求携带token
  - Token有效期：取决于Sa-Token配置文件
  - 密码加密：使用Sa-Token自带的MD5加密
- **个人信息管理**：修改头像、昵称、邮箱、密码、邀请码、邀请人
- **权限管理**：基于RBAC（基于角色的访问控制）模式
  - **角色定义**：系统预设普通用户、管理员角色
  - **权限分配**：为不同角色分配不同的操作权限
  - **自定义角色**：管理员可以创建自定义角色并分配权限
  - **用户-角色关联**：一个用户可以关联多个角色，权限为并集
  - **具体权限点**：
    - **用户管理权限**：user:view, user:create, user:edit, user:delete, user:disable, user:reset-password, user:assign-role, user:view-points, user:edit-points
    - **任务管理权限**：task:view, task:create, task:edit, task:delete, task:cancel, task:retry, task:view-log, task:view-resource
    - **社区管理权限**：community:view, community:share, community:download, community:approve, community:delete, community:view-reward
    - **系统管理权限**：system:config, system:view-log, system:view-resource, system:manage-role, system:manage-permission, system:data-statistics, system:backup, system:restore
    - **资源管理权限**：resource:view, resource:delete, resource:manage-storage

### 2. 积分与资源管理
- **积分获取**：
  - 注册奖励：50积分
  - 邀请好友奖励：邀请人获得20积分，被邀请人获得5积分
  - 社区分享奖励：他人下载分享内容时，作者获得5积分
- **积分消耗**：
  - 生成数据消耗：5积分/次
  - 下载社区数据消耗：10积分/次
- **积分记录**：详细的积分获取与消耗历史记录
- **积分规则**：
  - 积分无期限
  - 奖励比例可在管理后台由管理员控制
  - 防止SQL注入：使用MyBatis-Plus，自带防SQL注入功能


### 3. 任务配置管理
- **任务标题**：任务标题
- **题目信息**：完整的题面信息
  - 前端支持：markdown格式和代码高亮
  - LaTeX公式渲染：支持
  - 图片上传：不支持，只允许纯文本markdown
- **标准程序**：支持C++语言
  - 代码编辑器：使用Ace编辑器，支持代码高亮
  - 语法检查：支持
- **生成参数设置**：
  - 测试点数量：最少1个，最多20个
  - 测试点类型数量：由用户决定
- **测试点构造**：
  - **预设策略**：选择基础随机、边界极值、顺序特征、复杂度边界、特殊结构、数据分布、对抗性、组合特征等测试点类型
- **任务提交**：用户完成配置后提交任务，系统生成唯一任务ID并开始处理
- **任务执行超时**：单个任务最大执行时间为30分钟，超时后放入死信队列

### 4. 进度监控管理
- **状态实时更新**：任务提交、AI分析、数据生成、验证完成等状态
- **数据预览**：生成的测试数据样例预览，支持文本和表格形式
- **进度条**：可视化的任务完成进度

### 5. 数据导出管理
- **打包格式**：支持ZIP格式打包，包含.in/.out文件对
- **文件命名规则**：input1.in, output1.out格式
- **自定义文件名**：不允许
- **下载方式**：直接下载、生成下载链接（有效期设置）
- **数据存储**：
  - 生成的数据最多保存一周
  - 分享审核通过的数据一直有效
  - 用户存储空间不设限
  - 可以查看所有任务记录，但只能下载未被清理的数据

### 6. 社区管理
- **内容分享**：用户A分享自己的题目和数据
  - 内容审核：使用阿里云提供的接口审核
  - 举报机制：不需要
- **下载机制**：用户B可以浏览社区内容，花费积分下载感兴趣的题目和数据
  - 下载消耗：10积分/次
  - 作者奖励：5积分/次
- **积分奖励**：用户A分享的内容被其他用户下载后，可以获得积分奖励，奖励比例可配置
- **社区内容管理**：
  - 排序规则：支持多种排序方式
  - 搜索功能：支持
  - 筛选功能：支持

### 7. 管理后台
- **系统配置**：全局参数设置、服务管理、数据库管理、缓存管理
- **用户管理**：用户列表、用户操作、用户积分管理
- **任务管理**：任务列表、任务操作、任务监控
- **资源监控**：系统资源、服务状态、网络监控
- **数据统计与分析**：用户活跃度统计、任务执行统计、资源使用统计、数据分析

## 数据生成特性

数据生成部分采用可组合的构造特点选择模式，用户可多选的测试点类型包括：

- **基础随机测试点**：满足题目约束的完全随机数据
- **边界极值测试点**：包含输入范围的最大值、最小值、零值、空值
- **顺序特征测试点**：升序、降序、随机排列、完全逆序、部分有序
- **复杂度边界测试点**：刻意构造使特定时间复杂度算法超时的数据
- **特殊结构测试点**：特殊图结构（链、星、环、完全图、二分图）、树结构、特殊矩阵
- **数据分布测试点**：均匀分布、正态分布、指数分布、聚类分布
- **对抗性测试点**：针对常见错误解法的针对性构造数据
- **组合特征测试点**：多种特征组合的复杂测试点

## 社区功能

社区功能部分需要支持以下核心使用场景：

- 用户可将题目和数据分享到社区，其他用户可以使用题目和数据
- 优质分享者可获得积分奖励

## 管理后台功能

管理后台部分需要支持以下核心使用场景：


### 用户管理
- 用户列表：查看所有用户信息
- 用户操作：禁用/启用用户、重置密码、修改用户权限
- 用户积分管理：手动调整用户积分、查看积分变动记录

### 任务管理
- 任务列表：查看所有任务状态和详情
- 任务操作：暂停/取消/重试任务
- 任务监控：查看任务执行日志、资源使用情况

### 系统配置
- 全局参数设置：积分规则、任务限制等
- 服务管理：各服务运行状态
- 数据库管理：数据库连接状态
- 缓存管理：缓存使用情况

### 数据统计与分析
- **用户统计**：
  - 用户活跃度：日活跃用户数、周活跃用户数、月活跃用户数
  - 注册用户总数、活跃用户占比、用户增长趋势
  - 用户行为：平均登录次数、平均任务数、平均分享数、平均下载数、用户留存率
- **任务统计**：
  - 任务执行：总任务数、成功/失败任务数、任务成功率、平均执行时间、任务状态分布
  - 任务类型：各测试点类型使用频率、平均测试点数量、任务复杂度分布
- **积分统计**：
  - 积分流转：总发放积分、总消耗积分、积分余额、积分获取/消耗渠道分布
  - 积分趋势：日/周/月积分发放/消耗趋势
- **社区统计**：
  - 分享内容：总分享数、审核通过/拒绝数、平均审核时间、热门分享TOP10、分享类别分布
  - 下载行为：总下载数、平均下载数/用户、下载热门TOP10、下载趋势
- **系统资源统计**：
  - 服务器资源：CPU使用率、内存使用率、磁盘使用率、网络带宽使用情况
  - 服务状态：各服务运行状态、服务响应时间、错误率、消息队列堆积情况、缓存命中率
- **AI执行统计**：
  - AI性能：各AI组件执行时间、AI执行成功率、AI打回率、死信队列任务数、AI执行趋势


## 设计目标

| 文档属性     | 内容                                               |
| ------------ | -------------------------------------------------- |
| **产品名称** | **MAIGEN** (Multi-Agent Intelligent Generation)    |
| **核心理念** | 无状态计算 + 编排器模式 + 多智能体协同             |
| **设计目标** | 构建一个高可用、可水平扩展的智能化算法数据生成平台 |
| **技术架构** | Spring Boot 3 + React + MySQL + RabbitMQ + Redis   |
| **部署方式** | Docker Compose 容器化部署                         |
| **并发支持** | 支持20人并发，小项目                               |
| **水平扩展** | 多个单体 + 消息队列 + 缓存通信                    |

## 多AI工作流程

### AI流水线式工作流程
1. **题目分析AI**：分析题目描述，提取关键信息和约束条件
2. **策略构造AI**：根据题目分析结果，思考数据构造策略
3. **代码生成AI**：根据构造策略，编写数据生成代码
4. **代码评审AI**：评审生成的代码是否合理

### 工作机制
- **状态机模式**：类似于订单业务的状态机，每个AI负责一个阶段
- **打回机制**：代码评审不通过时打回重做，最多打回3次
- **死信队列**：打回3次后仍不通过，或AI调用失败多次后，放入死信队列
- **异常处理**：死信队列的任务记录到数据库和异常日志，告知用户任务失败
- **并行处理**：多个任务可以在不同阶段并行工作

### AI模型选择
- 暂定使用 Qwen3 模型
- API调用方式：查阅千文官方文档SDK，可能与Spring-AI集成
- 防止AI输入过多导致内容偏差：采用多AI分工协作

## 编排器模式

### 核心概念
- **状态机**：定义任务的各个状态（待分析、分析中、生成中、验证中、完成、失败等）
- **事件触发**：状态之间的转换由事件触发
- **流程定义**：预先定义任务执行的完整流程
- **协调中心**：编排器作为中央协调器，监控和管理整个流程

### 技术实现
- 使用 RabbitMQ 实现事件传递
- 使用状态机管理状态转换
- 使用分布式锁确保任务执行的唯一性
- 使用监控系统追踪任务执行进度

## Docker部署方案

### 基本架构
- **服务容器**：
  - maigen-backend：Spring Boot 应用
  - maigen-frontend：React 应用
  - mysql：数据库
  - rabbitmq：消息队列
  - redis：缓存

### 部署步骤
1. 编写 Dockerfile 构建前后端镜像
2. 编写 docker-compose.yml 定义服务编排
3. 配置环境变量和挂载卷
4. 执行 docker-compose up -d 启动服务

### 服务启动顺序
- 先启动依赖服务：mysql → redis → rabbitmq
- 再启动业务服务：backend → frontend

### 日志管理
- 使用 Docker 日志驱动收集容器日志
- 可配置 ELK 或其他日志分析系统

## 开发计划

### 分阶段开发
1. **第一阶段**：用户模块
   - 注册、登录、个人信息管理
   - 权限管理基础功能

2. **第二阶段**：任务核心流程
   - 任务配置管理
   - AI分析和数据生成
   - 进度监控和数据下载

3. **第三阶段**：积分系统
   - 积分获取和消耗
   - 积分记录管理

4. **第四阶段**：后台管理
   - 系统配置
   - 数据统计与分析

5. **第五阶段**：社区功能
   - 内容分享和审核
   - 积分奖励机制